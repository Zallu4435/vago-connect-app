generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    Int                       @id @default(autoincrement())
  name                  String                    @db.VarChar(255)
  email                 String                    @unique @db.VarChar(255)
  phone                 String?                   @unique @db.VarChar(50)
  profileImage          String?
  profileImagePublicId  String?                   @db.VarChar(255)
  profileImageVersion   Int?
  about                 String                    @default("Hey there! I am using WhatsApp")
  lastSeenPrivacy       String                    @default("everyone") @db.VarChar(20)
  profilePicturePrivacy String                    @default("everyone") @db.VarChar(20)
  aboutPrivacy          String                    @default("everyone") @db.VarChar(20)
  isOnline              Boolean                   @default(false)
  lastSeen              DateTime?
  readReceipts          Boolean                   @default(true)
  autoDownloadMedia     Boolean                   @default(true)
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  blockedByUsers        BlockedUser[]             @relation("Blocked")
  blockedUsers          BlockedUser[]             @relation("Blocker")
  contactOf             Contact[]                 @relation("ContactUser")
  contacts              Contact[]                 @relation("UserContacts")
  participations        ConversationParticipant[]
  conversationsCreated  Conversation[]            @relation("ConversationCreator")
  reactions             MessageReaction[]
  sentMessages          Message[]                 @relation("SentMessages")
  reportsReceived       ReportedUser[]            @relation("Reported")
  reportsSubmitted      ReportedUser[]            @relation("Reporter")
  reviewsPerformed      ReportedUser[]            @relation("Reviewer")
  typingIndicators      TypingIndicator[]

  @@index([email])
  @@index([phone])
  @@index([isOnline])
  @@index([lastSeen])
  @@map("users")
}

model Conversation {
  id                   Int                       @id @default(autoincrement())
  type                 String                    @db.VarChar(20)
  groupName            String?                   @db.VarChar(255)
  groupDescription     String?
  groupIcon            String?
  createdById          Int?
  disappearingMessages Boolean                   @default(false)
  disappearingDuration Int?
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt
  participants         ConversationParticipant[]
  creator              User?                     @relation("ConversationCreator", fields: [createdById], references: [id])
  messages             Message[]
  typingIndicators     TypingIndicator[]

  @@index([type])
  @@index([createdById])
  @@map("conversations")
}

model ConversationParticipant {
  id                   Int          @id @default(autoincrement())
  conversationId       Int
  userId               Int
  isPinned             Boolean      @default(false)
  pinnedAt             DateTime?
  pinOrder             Int          @default(0)
  isArchived           Boolean      @default(false)
  archivedAt           DateTime?
  keepArchived         Boolean      @default(false)
  isMuted              Boolean      @default(false)
  mutedUntil           DateTime?
  isDeleted            Boolean      @default(false)
  deletedAt            DateTime?
  clearedAt            DateTime?
  unreadCount          Int          @default(0)
  lastReadMessageId    Int?
  role                 String       @default("member") @db.VarChar(20)
  joinedAt             DateTime     @default(now())
  leftAt               DateTime?
  notificationsEnabled Boolean      @default(true)
  conversation         Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  lastReadMessage      Message?     @relation("LastReadMessage", fields: [lastReadMessageId], references: [id])
  user                 User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
  @@index([userId, isPinned])
  @@index([userId, isArchived])
  @@index([userId, isDeleted])
  @@map("conversation_participants")
}

model Message {
  id                   Int                       @id @default(autoincrement())
  conversationId       Int
  senderId             Int
  type                 String                    @db.VarChar(20)
  content              String?
  caption              String?
  fileName             String?                   @db.VarChar(255)
  fileSize             BigInt?
  mimeType             String?                   @db.VarChar(100)
  duration             Int?
  thumbnailUrl         String?
  status               String                    @default("sent") @db.VarChar(20)
  isEdited             Boolean                   @default(false)
  editedAt             DateTime?
  originalContent      String?
  editHistory          Json?                     @default("{}")
  isDeletedForEveryone Boolean                   @default(false)
  deletedForEveryoneAt DateTime?
  deletedBy            Json                      @default("[]")
  isForwarded          Boolean                   @default(false)
  originalMessageId    Int?
  forwardCount         Int                       @default(0)
  replyToMessageId     Int?
  quotedMessage        Json?
  starredBy            Json                      @default("[]")
  readBy               Json                      @default("[]")
  deliveredTo          Json                      @default("[]")
  mentions             Json                      @default("[]")
  expiresAt            DateTime?
  isSystemMessage      Boolean                   @default(false)
  systemMessageType    String?                   @db.VarChar(50)
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt
  lastReadBy           ConversationParticipant[] @relation("LastReadMessage")
  mediaFiles           MediaFile[]
  reactions            MessageReaction[]
  conversation         Conversation              @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  originalMessage      Message?                  @relation("ForwardedMessages", fields: [originalMessageId], references: [id])
  forwardedMessages    Message[]                 @relation("ForwardedMessages")
  replyToMessage       Message?                  @relation("MessageReplies", fields: [replyToMessageId], references: [id])
  replies              Message[]                 @relation("MessageReplies")
  sender               User                      @relation("SentMessages", fields: [senderId], references: [id])

  @@index([conversationId, createdAt(sort: Desc)])
  @@index([senderId])
  @@index([replyToMessageId])
  @@index([status])
  @@index([isDeletedForEveryone])
  @@index([expiresAt])
  @@map("messages")
}

model MessageReaction {
  id        Int      @id @default(autoincrement())
  messageId Int
  userId    Int
  emoji     String   @db.VarChar(10)
  createdAt DateTime @default(now())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
  @@index([emoji])
  @@map("message_reactions")
}

model BlockedUser {
  id        Int      @id @default(autoincrement())
  blockerId Int
  blockedId Int
  reason    String?
  blockedAt DateTime @default(now())
  blocked   User     @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)
  blocker   User     @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
  @@map("blocked_users")
}

model ReportedUser {
  id             Int       @id @default(autoincrement())
  reporterId     Int
  reportedId     Int
  conversationId Int?
  reason         String    @db.VarChar(100)
  description    String?
  status         String    @default("pending") @db.VarChar(20)
  reviewedBy     Int?
  reviewedAt     DateTime?
  actionTaken    String?
  reportedAt     DateTime  @default(now())
  reported       User      @relation("Reported", fields: [reportedId], references: [id])
  reporter       User      @relation("Reporter", fields: [reporterId], references: [id])
  reviewer       User?     @relation("Reviewer", fields: [reviewedBy], references: [id])

  @@index([reporterId])
  @@index([reportedId])
  @@index([status])
  @@map("reported_users")
}

model Contact {
  id              Int       @id @default(autoincrement())
  userId          Int
  contactUserId   Int
  displayName     String?   @db.VarChar(255)
  phoneNumber     String?   @db.VarChar(50)
  isBlocked       Boolean   @default(false)
  isFavorite      Boolean   @default(false)
  addedAt         DateTime  @default(now())
  lastContactedAt DateTime?
  contactUser     User      @relation("ContactUser", fields: [contactUserId], references: [id], onDelete: Cascade)
  user            User      @relation("UserContacts", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, contactUserId])
  @@index([userId])
  @@index([contactUserId])
  @@index([userId, isBlocked])
  @@index([userId, isFavorite])
  @@map("contacts")
}

model TypingIndicator {
  id             Int          @id @default(autoincrement())
  conversationId Int
  userId         Int
  isTyping       Boolean      @default(false)
  lastTypingAt   DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@map("typing_indicators")
}

model MediaFile {
  id                     Int       @id @default(autoincrement())
  messageId              Int
  storageKey             String    @db.VarChar(500)
  storageProvider        String    @default("cloudinary") @db.VarChar(50)
  originalName           String?   @db.VarChar(255)
  mimeType               String?   @db.VarChar(100)
  fileSize               BigInt?
  width                  Int?
  height                 Int?
  duration               Int?
  thumbnailKey           String?   @db.VarChar(500)
  thumbnailSize          BigInt?
  cloudinaryPublicId     String?   @db.VarChar(255)
  cloudinaryVersion      Int?
  cloudinaryResourceType String?   @db.VarChar(30)
  cloudinaryFormat       String?   @db.VarChar(20)
  cloudinaryFolder       String?   @db.VarChar(255)
  cloudinaryAssetId      String?   @db.VarChar(100)
  uploadStatus           String    @default("pending") @db.VarChar(20)
  downloadCount          Int       @default(0)
  isCompressed           Boolean   @default(false)
  originalFileSize       BigInt?
  uploadedAt             DateTime  @default(now())
  expiresAt              DateTime?
  message                Message   @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([storageKey])
  @@index([cloudinaryPublicId])
  @@index([expiresAt])
  @@map("media_files")
}
